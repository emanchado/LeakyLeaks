<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Leaky Leaks</title>
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="css/bootstrap-1.2.0.css" rel="stylesheet">
    <style>
      body { padding-top: 40px; }
    </style>
    <script src="lib/angular-0.9.19.min.js" ng:autobind></script>
    <script src="lib/CablePool.js"></script>
    <script src="lib/valentine.min.js"></script>
    <script src="lib/utils.js"></script>
    <script>
    angular.filter('excerpt', function(input, limit) {
      var text = excerpt(input, limit);
      // If everything in uppercase, change to lowercase
      if (! text.match(/[a-z]/)) {
        return text.toLocaleLowerCase();
      } else {
        return text;
      }
    });
    angular.filter('bodytext', function(input) {
      var text = input;
      // If everything in uppercase, change to lowercase
      if (! text.match(/[a-z]/)) {
        text = text.toLocaleLowerCase();
      }
      return text.replace(/\n/g, "<br/>");
    });

    LeakyLeaksController.$inject = ['$resource'];
    function LeakyLeaksController($resource) {
      this.LeakFeedProxy = $resource(
        'http://api.leakfeed.com/v1/:type/:id.json',
        { callback: 'JSON_CALLBACK' },
        { getByTag:    {method: 'JSON', isArray: true,
                                        params: {type: 'cables/tag'}},
          getByOffice: {method: 'JSON', isArray: true,
                                        params: {type: 'cables/office'}},
          getTags:     {method: 'JSON', isArray: true,
                                        params: {type: 'cables', id: 'tags'}},
          getOffices:  {method: 'JSON', isArray: true,
                                        params: {type: 'cables',
                                                 id: 'offices'}}}
      );
      this.LeakFeedProxyTest = $resource(
        'http://localhost/:id.json',
        { },
        { getByTag:    {method: 'GET', isArray: true},
          getByOffice: {method: 'GET', isArray: true},
          getTags:     {method: 'GET', isArray: true, params: {id: 'tags'}},
          getOffices:  {method: 'GET', isArray: true, params: {id: 'offices'}}}
      );
    }
    LeakyLeaksController.prototype = {
      init: function() {
        this.cablePool = new CablePool;
        this.setupTags();
        this.setupOffices();
      },
      setupTags: function(tag) {
        this.availableTags = this.LeakFeedProxy.getTags();
      },
      setupOffices: function(tag) {
        this.availableOffices = this.LeakFeedProxy.getOffices();
      },
      fetchCablesByTag: function(tag) {
        var self = this;
        var rawCableData = this.LeakFeedProxyTest.getByTag({id: tag}, function() {
            self.cablePool.reset();
            self.cablePool.addCables(rawCableData);
        });
      },
      fetchCablesByOffice: function(office) {
        var self = this;
        var rawCableData = this.LeakFeedProxyTest.getByOffice({id: office}, function() {
            self.cablePool.reset();
            self.cablePool.addCables(rawCableData);
        });
      },
      search: function() {
        if (this.office) {
          this.fetchCablesByOffice(this.office);
        }
        return false;
      }
    };
    </script>
  </head>
  <body ng:controller="LeakyLeaksController" ng:init="fetchCablesByOffice('Embassy_Tehran')">
    <div class="topbar">
      <div class="fill">
        <div class="container">
          <h3><a href="#">Leaky Leaks</a></h3>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="sidebar">
        <form class="form-stacked" ng:submit="search()">
          <h2>Filters</h2>

          <div class="clearfix">
            <label for="text">Text:</label>
            <input id="text" type="text" name="text" style="width: auto" placeholder="Keywords" />
          </div>

          <div class="clearfix">
            <label for="tags">Tags:</label>
            <select multiple id="tags" name="tags" size="15" style="height: auto">
              <option ng:repeat="t in availableTags" value="{{t.name}}">{{t.display_name}} ({{t.cables}})</option>
            </select>
          </div>

          <div class="clearfix">
            <label for="office">Office:</label>
            <select id="office" name="office" style="height: auto">
              <option ng:repeat="o in availableOffices" value="{{o.name}}">{{o.display_name}} ({{o.cables}})</option>
            </select>
          </div>

          <input id="searchBtn" class="btn primary" type="submit" value="Search" />
        </form>
      </div>

      <div class="content">
        <h2>Cables ({{cablePool.cablesWithWords(filterText).length}})</h2>

        <input type="text" name="filterText" placeholder="Filter by this text..." />

        <div ng:repeat="cable in cablePool.cablesWithWords(filterText)" class="cable">
          <h3>{{cable.subject}} &mdash; from {{cable.office}}</h3>
          <div class="date">{{cable.date_sent}}</div>

          <div class="body">{{cable.body|excerpt:500}} <a href="#" onclick="document.getElementById('text-{{cable.identifier}}').style.display = ''">Read more</a></div>

          <div id="text-{{cable.identifier}}" class="modal" style="display: none; position: fixed; top: 400px; left: 400px; width: 60%; height: 60%; overflow: auto">
            <div class="modal-header">
              <h3>{{cable.identifier}} &mdash; {{cable.subject}}</h3>
              <a href="#" onclick="document.getElementById('text-{{cable.identifier}}').style.display = 'none'" class="close">Ã—</a>
            </div>
            <div class="modal-body">
              {{cable.body|bodytext|html}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
