<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Leaky Leaks</title>
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le styles -->
    <link href="css/bootstrap-1.2.0.css" rel="stylesheet">
    <style>
      body { padding-top: 40px; }
    </style>
    <script src="lib/angular-0.9.19.min.js" ng:autobind></script>
    <script src="lib/CablePool.js"></script>
    <script src="lib/valentine.min.js"></script>
    <script src="lib/utils.js"></script>
    <script>
    angular.filter('excerpt', function(input, limit) {
      var text = excerpt(input, limit);
      // If everything in uppercase, change to lowercase
      if (! text.match(/[a-z]/)) {
        return text.toLocaleLowerCase();
      } else {
        return text;
      }
    });
    angular.filter('bodytext', function(input) {
      var text = input;
      // If everything in uppercase, change to lowercase
      if (! text.match(/[a-z]/)) {
        text = text.toLocaleLowerCase();
      }
      return text.replace(/\n/g, "<br/>");
    });

    LeakyLeaksController.$inject = ['$resource'];
    function LeakyLeaksController($resource) {
      this.LeakFeedProxy = $resource(
        'http://api.leakfeed.com/v1/cables/tag/:tag.json',
        { callback: 'JSON_CALLBACK' },
        { getByTag: {method: 'JSON', isArray: true}}
      );
      this.LeakFeedProxyTest = $resource(
        'http://localhost/:tag.json',
        { },
        { getByTag: {method: 'GET', isArray: true}}
      );
    }
    LeakyLeaksController.prototype = {
      init: function() {
        this.cablePool = new CablePool;
      },
      fetchCablesByTag: function(tag) {
        var self = this;
        var rawCableData = this.LeakFeedProxyTest.getByTag({tag: tag}, function() {
            self.cablePool.addCables(rawCableData);
        });
      }
    };
    </script>
  </head>
  <body ng:controller="LeakyLeaksController" ng:init="fetchCablesByTag('XF')">
    <div class="topbar">
      <div class="fill">
        <div class="container">
          <h3><a href="#">Leaky Leaks</a></h3>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="sidebar">
        <form class="form-stacked">
          <h2>Filters</h2>

          <div class="clearfix">
            <label for="text">Text:</label>
            <input id="text" type="text" name="text" style="width: auto" placeholder="Keywords" />
          </div>

          <div class="clearfix">
            <label for="tags">Tags:</label>
            <select multiple id="tags" name="tags" style="height: auto">
              <option name="VAT">VAT (1)</option>
              <option name="PREL">PREL (8484)</option>
              <option name="PHUM">PHUM (2166)</option>
            </select>
          </div>

          <div class="clearfix">
            <label for="offices">Office(s):</label>
            <select multiple id="offices" name="offices" style="height: auto">
              <option name="Embassy_Tehran">E. Tehran (5)</option>
              <option name="Consulate_Vancouver">C. Vancouver (39)</option>
              <option name="Embassy_Sofia">E. Sofia (85)</option>
            </select>
          </div>

          <input class="btn primary" type="submit" value="Search" />
        </form>
      </div>

      <div class="content">
        <h2>Cables</h2>

        <div ng:repeat="cable in cablePool.cables" class="cable">
          <h3>{{cable.subject}} &mdash; from {{cable.office}}</h3>
          <div class="date">{{cable.date_sent}}</div>

          <div class="body">{{cable.body|excerpt:500}} <a href="#" onclick="document.getElementById('text-{{cable.identifier}}').style.display = ''">Read more</a></div>

          <div id="text-{{cable.identifier}}" class="modal" style="display: none; position: fixed; top: 400px; left: 400px; width: 60%; height: 60%; overflow: auto">
            <div class="modal-header">
              <h3>{{cable.identifier}} &mdash; {{cable.subject}}</h3>
              <a href="#" onclick="document.getElementById('text-{{cable.identifier}}').style.display = 'none'" class="close">Ã—</a>
            </div>
            <div class="modal-body">
              {{cable.body|bodytext|html}}
            </div>
          </div>

          <div class="tags"><strong>Tags:</strong> PFOR (1), IR (702), PK (406), XF (58)</div>
        </div>
      </div>
    </div>
  </body>
</html>
